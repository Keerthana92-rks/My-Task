name: DevOps Metrics

on:
  push:
    branches:
      - main

jobs:
  metrics:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14

    - name: Install Dependencies
      run: npm install

    - name: Build
      run: |
        npm run build
        echo "Build completed."

    - name: Run Tests
      run: |
        npm test
        echo "Tests completed."

    - name: Push Metrics to Prometheus Pushgateway
      run: |
        # Calculate build duration in seconds
        BUILD_START=$(date -u +%s)
        npm run build
        BUILD_SUCCESS=$?
        BUILD_END=$(date -u +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))

        echo "Build Duration (seconds): $BUILD_DURATION"
        echo "Build Success: $BUILD_SUCCESS"

        # Push metrics to Prometheus Pushgateway
        cat <<EOF | curl --data-binary @- http://54.196.98.45:9091/metrics/job/github-actions
        # TYPE build_duration_seconds gauge
        build_duration_seconds $BUILD_DURATION
        # TYPE build_success_status gauge
        build_success_status $BUILD_SUCCESS
        EOF
